<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FSA Trendreport – Dashboard</title>
  <meta name="description" content="FSA Trend-Dashboard: Monats- und Jahresansicht, Charts, Heatmaps, Quellen, Beitragskarten.">
  <style>
    :root{
      --bg:#050814; --bg2:#020617;
      --panel:rgba(15,23,42,.92); --panel2:rgba(15,23,42,.82);
      --text:#e9edf3; --muted:#97a0ad;
      --gold:#d4af37; --gold2:#f1d070;
      --ring:rgba(212,175,55,.25);
      --shadow:0 12px 35px rgba(0,0,0,.55);
      --radius:16px; --maxw:1180px;
      --ok:rgba(80,255,140,.30);
      --warn:rgba(241,208,112,.26);
      --bad:rgba(255,80,80,.22);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(900px 520px at 20% 10%, rgba(212,175,55,.14), transparent 55%),
                  radial-gradient(780px 520px at 80% 20%, rgba(241,208,112,.10), transparent 60%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    a{color:var(--gold2); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:var(--maxw); margin:0 auto; padding:24px 16px 70px}
    .topbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:44px; height:44px; display:grid; place-items:center; border-radius:14px;
      background:linear-gradient(180deg, rgba(212,175,55,.22), rgba(212,175,55,.06));
      border:1px solid rgba(212,175,55,.28);
      box-shadow: 0 10px 26px rgba(0,0,0,.45);
    }
    .title h1{margin:0; font-size:18px; letter-spacing:.2px}
    .title .sub{margin-top:2px; color:var(--muted); font-size:12px}
    .btns{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; gap:10px;
      border:1px solid rgba(212,175,55,.30);
      background:linear-gradient(180deg, rgba(15,23,42,.82), rgba(15,23,42,.62));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      box-shadow:var(--shadow);
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{border-color:rgba(241,208,112,.55)}
    .btn .dot{width:10px; height:10px; border-radius:50%; background:rgba(241,208,112,.65); box-shadow:0 0 0 6px rgba(212,175,55,.14)}
    .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:14px; margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background:var(--panel);
      border:1px solid rgba(212,175,55,.22);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 8px; font-size:15px}
    .muted{color:var(--muted)}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px}
    select, .pill{
      background:rgba(255,255,255,.04);
      border:1px solid rgba(212,175,55,.18);
      border-radius:12px;
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    .pill{display:inline-flex; gap:10px; align-items:center}
    .hr{height:1px; background:rgba(212,175,55,.18); margin:12px 0}
    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:10px}
    @media (max-width: 760px){ .kpi{grid-template-columns:1fr 1fr} }
    @media (max-width: 520px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{
      background:var(--panel2);
      border:1px solid rgba(212,175,55,.18);
      border-radius:14px;
      padding:12px;
      min-height:74px;
    }
    .kpi .v{font-size:22px; margin:2px 0 2px}
    .kpi .l{font-size:12px; color:var(--muted)}
    .quality{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;
      font-size:12px;
    }
    .badge{
      border:1px solid rgba(212,175,55,.16);
      border-radius:999px;
      padding:6px 10px;
      background:rgba(255,255,255,.03);
    }
    .badge.ok{background:var(--ok)}
    .badge.warn{background:var(--warn)}
    .badge.bad{background:var(--bad)}
    .months{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .mbtn{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(212,175,55,.18);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      font-size:12px;
      user-select:none;
    }
    .mbtn:hover{border-color:rgba(241,208,112,.55)}
    .mbtn.active{
      border-color:rgba(241,208,112,.65);
      box-shadow:0 0 0 6px rgba(212,175,55,.12);
    }
    .chartBox{
      margin-top:10px;
      padding:10px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(212,175,55,.14);
      border-radius:14px;
    }
    table{width:100%; border-collapse:collapse; font-size:12px}
    th,td{padding:8px 8px; border-bottom:1px solid rgba(212,175,55,.12); text-align:left; vertical-align:top}
    th{color:rgba(233,237,243,.90)}
    .cards{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:10px}
    @media (max-width: 900px){ .cards{grid-template-columns:1fr} }
    .item{
      background:var(--panel2);
      border:1px solid rgba(212,175,55,.16);
      border-radius:14px;
      padding:12px;
    }
    .item .t{font-weight:700; font-size:13px; line-height:1.25}
    .item .m{margin-top:6px; font-size:12px; color:rgba(233,237,243,.84); line-height:1.35}
    .item .meta{margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; font-size:11px; color:var(--muted)}
    .hint{
      font-size:12px; color:rgba(233,237,243,.84);
      background:rgba(255,255,255,.04);
      border:1px solid rgba(212,175,55,.14);
      border-radius:14px;
      padding:12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- inline SVG only -->
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
            <path d="M12 2l2.4 6.1L21 9.2l-5 4.2L17.3 21 12 17.8 6.7 21 8 13.4 3 9.2l6.6-1.1L12 2z" stroke="rgba(241,208,112,.95)" stroke-width="1.4"/>
          </svg>
        </div>
        <div class="title">
          <h1 data-i18n="h1">FSA Trendreport – Dashboard</h1>
          <div class="sub">
            <span data-i18n="sub1">Visuelle Trend-Übersicht</span> ·
            <span class="muted" data-i18n="sub2">öffentlich zugängliche Online-Signale (nicht repräsentativ)</span>
          </div>
        </div>
      </div>

      <div class="btns">
        <button class="btn" id="langBtn" type="button" title="DE/EN">
          <span class="dot" aria-hidden="true"></span>
          <span id="langLabel">DE</span>
        </button>
        <a class="btn" href="index.html">
          <span class="dot" aria-hidden="true"></span>
          <span data-i18n="btn_timeline">Chronologie</span>
        </a>
        <a class="btn" href="2025.html" id="yearLink">
          <span class="dot" aria-hidden="true"></span>
          <span data-i18n="btn_year">Jahresübersicht</span>
        </a>
        <a class="btn" href="2025-rundflug.html" id="rundflugLink">
          <span class="dot" aria-hidden="true"></span>
          <span data-i18n="btn_flight">Trend-Rundflug</span>
        </a>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2 data-i18n="sec_controls">Steuerung</h2>
        <div class="muted" data-i18n="controls_hint">Wähle Jahr/Monat. Dashboard liest die Daten aus data/manifest.json.</div>

        <div class="controls">
          <div class="pill">
            <span class="muted" data-i18n="lbl_year">Jahr</span>
            <select id="yearSel" aria-label="Year"></select>
          </div>
          <div class="pill">
            <span class="muted" data-i18n="lbl_month">Monat</span>
            <span id="monthLabel">—</span>
          </div>
          <div class="pill">
            <span class="muted" data-i18n="lbl_updated">Aktualisiert</span>
            <span id="updatedAt">—</span>
          </div>
        </div>

        <div class="months" id="monthButtons"></div>

        <div class="hr"></div>

        <h2 data-i18n="sec_kpis">KPIs</h2>
        <div class="kpi">
          <div class="box">
            <div class="v" id="kpiItems">0</div>
            <div class="l" data-i18n="kpi_items">Items (Monat)</div>
          </div>
          <div class="box">
            <div class="v" id="kpiSent">0.00</div>
            <div class="l" data-i18n="kpi_sent">Tonalität (Score)</div>
          </div>
          <div class="box">
            <div class="v" id="kpiTop">—</div>
            <div class="l" data-i18n="kpi_top">Top-Thema</div>
          </div>
          <div class="box">
            <div class="v" id="kpiSources">0/0</div>
            <div class="l" data-i18n="kpi_sources">Quellen OK/Total</div>
          </div>
        </div>

        <div class="quality" id="qualityRow"></div>

        <div class="hr"></div>

        <h2 data-i18n="sec_monthCharts">Monat – Charts</h2>

        <div class="chartBox">
          <div class="muted" data-i18n="chart_topics">Themenverteilung (Monat)</div>
          <div id="chartTopics"></div>
        </div>

        <div class="chartBox">
          <div class="muted" data-i18n="chart_yearline">Sentiment-Linie (Jahr)</div>
          <div id="chartYearLine"></div>
        </div>

        <div class="chartBox">
          <div class="muted" data-i18n="chart_heatmap">Heatmap (Monate × Themen)</div>
          <div id="chartHeatmap"></div>
        </div>

        <div class="hr"></div>

        <div class="hint">
          <strong data-i18n="note_title">Hinweis zur Einordnung:</strong>
          <span data-i18n="note_text">
            Dieses Tool misst keine „Bevölkerungs-Meinung“, sondern erstellt ein reproduzierbares Trendbild aus öffentlich zugänglichen Online-Signalen.
            Die Datenqualität wird immer sichtbar angezeigt.
          </span>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2 data-i18n="sec_sources">Quellen & Stabilität</h2>
        <div class="muted" data-i18n="sources_hint">Wie viele Items pro Quelle im Monat + Dropped/Failed.</div>
        <div class="chartBox">
          <div id="sourcesTable"></div>
        </div>

        <div class="hr"></div>

        <h2 data-i18n="sec_items">Beobachtete Beiträge (Monat)</h2>
        <div class="muted" data-i18n="items_hint">Titel + Snippet + Quelle + Datum. Links öffnen extern.</div>
        <div class="cards" id="itemsCards"></div>
      </div>
    </div>
  </div>

  <script>
    const I18N = {
      de: {
        h1: "FSA Trendreport – Dashboard",
        sub1: "Visuelle Trend-Übersicht",
        sub2: "öffentlich zugängliche Online-Signale (nicht repräsentativ)",
        btn_timeline: "Chronologie",
        btn_year: "Jahresübersicht",
        btn_flight: "Trend-Rundflug",
        sec_controls: "Steuerung",
        controls_hint: "Wähle Jahr/Monat. Dashboard liest die Daten aus data/manifest.json.",
        lbl_year: "Jahr",
        lbl_month: "Monat",
        lbl_updated: "Aktualisiert",
        sec_kpis: "KPIs",
        kpi_items: "Items (Monat)",
        kpi_sent: "Tonalität (Score)",
        kpi_top: "Top-Thema",
        kpi_sources: "Quellen OK/Total",
        sec_monthCharts: "Monat – Charts",
        chart_topics: "Themenverteilung (Monat)",
        chart_yearline: "Sentiment-Linie (Jahr)",
        chart_heatmap: "Heatmap (Monate × Themen)",
        note_title: "Hinweis zur Einordnung:",
        note_text: "Dieses Tool misst keine „Bevölkerungs-Meinung“, sondern erstellt ein reproduzierbares Trendbild aus öffentlich zugänglichen Online-Signalen. Die Datenqualität wird immer sichtbar angezeigt.",
        sec_sources: "Quellen & Stabilität",
        sources_hint: "Wie viele Items pro Quelle im Monat + Dropped/Failed.",
        sec_items: "Beobachtete Beiträge (Monat)",
        items_hint: "Titel + Snippet + Quelle + Datum. Links öffnen extern.",
        q_ok: "Datenqualität: OK",
        q_warn: "Datenqualität: dünn",
        q_bad: "Datenqualität: sehr dünn",
        q_sources: "Quellen",
        q_dropped: "Dropped",
        q_failed: "Failed",
        q_note: "Hinweis"
      },
      en: {
        h1: "FSA Trend Report – Dashboard",
        sub1: "Visual trend overview",
        sub2: "publicly available online signals (not representative)",
        btn_timeline: "Timeline",
        btn_year: "Year overview",
        btn_flight: "Trend flight",
        sec_controls: "Controls",
        controls_hint: "Select year/month. Dashboard reads data from data/manifest.json.",
        lbl_year: "Year",
        lbl_month: "Month",
        lbl_updated: "Updated",
        sec_kpis: "KPIs",
        kpi_items: "Items (month)",
        kpi_sent: "Tone (score)",
        kpi_top: "Top topic",
        kpi_sources: "Sources OK/Total",
        sec_monthCharts: "Month – charts",
        chart_topics: "Topic distribution (month)",
        chart_yearline: "Sentiment line (year)",
        chart_heatmap: "Heatmap (months × topics)",
        note_title: "Interpretation note:",
        note_text: "This tool does not measure “public opinion”. It creates a reproducible trend view from publicly available online signals. Data quality is always shown.",
        sec_sources: "Sources & stability",
        sources_hint: "How many items per source in the month + dropped/failed.",
        sec_items: "Observed items (month)",
        items_hint: "Title + snippet + source + date. Links open externally.",
        q_ok: "Data quality: OK",
        q_warn: "Data quality: thin",
        q_bad: "Data quality: very thin",
        q_sources: "Sources",
        q_dropped: "Dropped",
        q_failed: "Failed",
        q_note: "Note"
      }
    };

    function getLang(){
      return (localStorage.getItem("fsa_lang") || document.documentElement.lang || "de").startsWith("en") ? "en" : "de";
    }
    function setLang(lang){
      const L = (lang === "en") ? "en" : "de";
      localStorage.setItem("fsa_lang", L);
      document.documentElement.lang = L;
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const k = el.getAttribute("data-i18n");
        if (I18N[L][k] !== undefined) el.textContent = I18N[L][k];
      });
      document.getElementById("langLabel").textContent = L.toUpperCase();
      renderQualityBadge(currentMonthData);
    }
    document.getElementById("langBtn").addEventListener("click", ()=> setLang(getLang()==="de" ? "en":"de"));
    setLang(getLang());

    const state = {
      manifest: null,
      year: null,
      month: null
    };

    let currentMonthData = null;

    const elYearSel = document.getElementById("yearSel");
    const elMonthLabel = document.getElementById("monthLabel");
    const elUpdatedAt = document.getElementById("updatedAt");
    const elMonthButtons = document.getElementById("monthButtons");

    const elKpiItems = document.getElementById("kpiItems");
    const elKpiSent = document.getElementById("kpiSent");
    const elKpiTop = document.getElementById("kpiTop");
    const elKpiSources = document.getElementById("kpiSources");
    const elQualityRow = document.getElementById("qualityRow");

    const elChartTopics = document.getElementById("chartTopics");
    const elChartYearLine = document.getElementById("chartYearLine");
    const elChartHeatmap = document.getElementById("chartHeatmap");

    const elSourcesTable = document.getElementById("sourcesTable");
    const elItemsCards = document.getElementById("itemsCards");

    const yearLink = document.getElementById("yearLink");
    const rundflugLink = document.getElementById("rundflugLink");

    function esc(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

    async function loadManifest(){
      const res = await fetch("data/manifest.json?nocache=" + Date.now());
      if(!res.ok) throw new Error("manifest.json not found");
      const m = await res.json();
      state.manifest = m;

      const years = (m.years || []).slice().sort((a,b)=>b-a);
      elYearSel.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join("");

      state.year = years[0] || new Date().getFullYear();
      elYearSel.value = String(state.year);
      elUpdatedAt.textContent = m.generated_at || "—";

      elYearSel.addEventListener("change", ()=>{
        state.year = parseInt(elYearSel.value,10);
        buildMonthButtons();
        // pick latest month of that year
        const months = (state.manifest.months_by_year[String(state.year)] || []);
        state.month = months[0] || null;
        if(state.month) loadMonth(state.month);
        renderYearCharts();
        updateYearLinks();
      });

      buildMonthButtons();
      // default month = latest for that year
      const months = (m.months_by_year[String(state.year)] || []);
      state.month = months[0] || null;
      if(state.month) await loadMonth(state.month);
      renderYearCharts();
      updateYearLinks();
    }

    function updateYearLinks(){
      yearLink.setAttribute("href", `${state.year}.html`);
      rundflugLink.setAttribute("href", `${state.year}-rundflug.html`);
    }

    function buildMonthButtons(){
      elMonthButtons.innerHTML = "";
      const months = (state.manifest.months_by_year[String(state.year)] || []);
      months.forEach(ym=>{
        const b = document.createElement("div");
        b.className = "mbtn" + (ym===state.month ? " active":"");
        b.textContent = ym;
        b.addEventListener("click", ()=>{
          state.month = ym;
          [...elMonthButtons.querySelectorAll(".mbtn")].forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          loadMonth(ym);
        });
        elMonthButtons.appendChild(b);
      });
      elMonthLabel.textContent = state.month || "—";
    }

    function renderQualityBadge(monthData){
      if(!monthData || !monthData.quality){
        elQualityRow.innerHTML = "";
        return;
      }
      const L = getLang();
      const q = monthData.quality;
      const n = (monthData.items_total||0);

      let cls = "bad";
      let label = I18N[L].q_bad;
      if(n >= 50 && q.sources_ok >= 3) { cls="ok"; label=I18N[L].q_ok; }
      else if(n >= 15 && q.sources_ok >= 2) { cls="warn"; label=I18N[L].q_warn; }

      const parts = [
        `<span class="badge ${cls}">${esc(label)}</span>`,
        `<span class="badge">${esc(I18N[L].q_sources)}: ${q.sources_ok}/${q.sources_total}</span>`,
        `<span class="badge">${esc(I18N[L].q_failed)}: ${q.sources_failed}</span>`,
        `<span class="badge">${esc(I18N[L].q_dropped)}: ${q.dropped_total}</span>`,
        `<span class="badge">${esc(I18N[L].q_note)}: ${esc(q.note || "")}</span>`
      ];
      elQualityRow.innerHTML = parts.join("");
    }

    function svgBarChart(topics){
      const w=640, h=180, padL=160, padR=20, padT=20, padB=20;
      const innerW=w-padL-padR;
      const barH=12;
      const gap=8;
      const max = Math.max(1, ...topics.map(t=>t.count||0));
      const rows = topics.slice(0,7).map((t,i)=>{
        const y = padT + i*(barH+gap);
        const bw = Math.round(innerW * ((t.count||0)/max));
        return `
          <text x="0" y="${y+10}" fill="currentColor" font-size="12">${esc(t.label_de||t.key)}</text>
          <rect x="${padL}" y="${y}" width="${bw}" height="${barH}" rx="4" fill="rgba(212,175,55,.45)"></rect>
          <text x="${padL + bw + 8}" y="${y+10}" fill="rgba(233,237,243,.85)" font-size="12">${t.count||0}</text>
        `;
      }).join("");
      return `
        <svg width="100%" viewBox="0 0 ${w} ${h}" role="img" aria-label="Bar chart">
          <rect x="0" y="0" width="${w}" height="${h}" rx="14" fill="rgba(0,0,0,.18)"></rect>
          <g transform="translate(12,10)" fill="none">${rows}</g>
        </svg>
      `;
    }

    function svgLineChart(points, labels){
      const w=640, h=180, padX=30, padY=25;
      const innerW=w-2*padX, innerH=h-2*padY;
      const vals = points.map(p=>p.v);
      let min = Math.min(...vals, 0);
      let max = Math.max(...vals, 0);
      if(min===max){ min-=1; max+=1; }

      const xAt = (i)=> padX + (labels.length<=1 ? innerW/2 : innerW*(i/(labels.length-1)));
      const yAt = (v)=> padY + innerH*(1-((v-min)/(max-min)));

      const d = points.map((p,i)=>`${i===0?'M':'L'} ${xAt(i).toFixed(1)} ${yAt(p.v).toFixed(1)}`).join(" ");
      const dots = points.map((p,i)=>`<circle cx="${xAt(i).toFixed(1)}" cy="${yAt(p.v).toFixed(1)}" r="3.2" fill="rgba(212,175,55,.55)"></circle>`).join("");

      return `
        <svg width="100%" viewBox="0 0 ${w} ${h}" role="img" aria-label="Line chart">
          <rect x="0" y="0" width="${w}" height="${h}" rx="14" fill="rgba(0,0,0,.18)"></rect>
          <path d="M ${padX} ${padY} L ${padX} ${h-padY}" stroke="rgba(212,175,55,.20)" stroke-width="1"></path>
          <path d="M ${padX} ${h-padY} L ${w-padX} ${h-padY}" stroke="rgba(212,175,55,.20)" stroke-width="1"></path>
          <path d="${d}" fill="none" stroke="rgba(241,208,112,.92)" stroke-width="2.2"></path>
          ${dots}
        </svg>
      `;
    }

    function svgHeatmap(months, topicKeys, matrix, topicLabels){
      // months: ["2025-01"...], topicKeys: ["eu"...]
      const cellW=44, cellH=18, padL=120, padT=26, padR=10, padB=10;
      const w = padL + months.length*cellW + padR;
      const h = padT + topicKeys.length*cellH + padB;

      // max value
      let max = 1;
      for(const k of topicKeys){
        for(const m of months){
          max = Math.max(max, (matrix[k] && matrix[k][m]) ? matrix[k][m] : 0);
        }
      }
      const cells = [];
      topicKeys.forEach((k,ri)=>{
        months.forEach((m,ci)=>{
          const v = (matrix[k] && matrix[k][m]) ? matrix[k][m] : 0;
          const a = (v/max);
          const fill = `rgba(212,175,55,${(0.08 + 0.62*a).toFixed(3)})`;
          const x = padL + ci*cellW;
          const y = padT + ri*cellH;
          cells.push(`<rect x="${x}" y="${y}" width="${cellW-2}" height="${cellH-2}" rx="4" fill="${fill}"></rect>`);
        });
      });

      const monthLabels = months.map((m,i)=>`<text x="${padL + i*cellW + 4}" y="16" fill="rgba(233,237,243,.70)" font-size="10">${esc(m.slice(5))}</text>`).join("");
      const rowLabels = topicKeys.map((k,i)=>`<text x="0" y="${padT + i*cellH + 12}" fill="currentColor" font-size="12">${esc(topicLabels[k] || k)}</text>`).join("");

      return `
        <svg width="100%" viewBox="0 0 ${w} ${h}" role="img" aria-label="Heatmap">
          <rect x="0" y="0" width="${w}" height="${h}" rx="14" fill="rgba(0,0,0,.18)"></rect>
          <g transform="translate(12,10)">
            ${monthLabels}
            ${rowLabels}
            ${cells.join("")}
          </g>
        </svg>
      `;
    }

    function renderSourcesTable(sources){
      if(!sources || !sources.length){
        elSourcesTable.innerHTML = `<div class="muted">—</div>`;
        return;
      }
      const rows = sources.map(s=>{
        return `<tr>
          <td>${esc(s.name || "")}</td>
          <td>${esc(s.category || "")}</td>
          <td>${(s.items||0)}</td>
          <td>${(s.dropped_out_of_month||0)}</td>
          <td>${(s.failed ? "YES" : "NO")}</td>
        </tr>`;
      }).join("");
      elSourcesTable.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Source</th><th>Cat</th><th>Items</th><th>Dropped</th><th>Failed</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function renderItemsCards(items){
      elItemsCards.innerHTML = "";
      if(!items || !items.length){
        elItemsCards.innerHTML = `<div class="muted">—</div>`;
        return;
      }
      items.slice(0,24).forEach(it=>{
        const div = document.createElement("div");
        div.className = "item";
        const url = it.link || "";
        div.innerHTML = `
          <div class="t">${url ? `<a href="${esc(url)}" target="_blank" rel="noopener noreferrer">${esc(it.title||"")}</a>` : esc(it.title||"")}</div>
          <div class="m">${esc(it.snippet||"")}</div>
          <div class="meta">
            <span>${esc(it.source||"")}</span>
            <span>${esc(it.published||"")}</span>
            ${it.topics && it.topics.length ? `<span>Topics: ${esc(it.topics.join(", "))}</span>` : ``}
          </div>
        `;
        elItemsCards.appendChild(div);
      });
    }

    async function loadMonth(ym){
      if(!ym) return;
      elMonthLabel.textContent = ym;

      // update month buttons active state
      [...elMonthButtons.querySelectorAll(".mbtn")].forEach(b=>{
        b.classList.toggle("active", b.textContent.trim()===ym);
      });

      const res = await fetch(`data/${ym}.json?nocache=${Date.now()}`);
      if(!res.ok){
        currentMonthData = null;
        elKpiItems.textContent = "0";
        elKpiSent.textContent = "0.00";
        elKpiTop.textContent = "—";
        elKpiSources.textContent = "0/0";
        elChartTopics.innerHTML = `<div class="muted">—</div>`;
        elSourcesTable.innerHTML = `<div class="muted">—</div>`;
        elItemsCards.innerHTML = `<div class="muted">—</div>`;
        elQualityRow.innerHTML = "";
        return;
      }
      const d = await res.json();
      currentMonthData = d;

      elKpiItems.textContent = String(d.items_total||0);
      elKpiSent.textContent = (d.sentiment && typeof d.sentiment.avg==="number") ? d.sentiment.avg.toFixed(2) : "0.00";
      elKpiTop.textContent = d.top_topic_de || "—";
      const q = d.quality || { sources_ok:0, sources_total:0 };
      elKpiSources.textContent = `${q.sources_ok||0}/${q.sources_total||0}`;
      renderQualityBadge(d);

      elChartTopics.innerHTML = svgBarChart((d.topics||[]));
      renderSourcesTable(d.sources_used||[]);
      renderItemsCards(d.items||[]);
    }

    function renderYearCharts(){
      const m = state.manifest;
      if(!m) return;

      const year = state.year;
      const months = (m.months_by_year[String(year)] || []).slice().sort(); // asc for charts
      if(!months.length){
        elChartYearLine.innerHTML = `<div class="muted">—</div>`;
        elChartHeatmap.innerHTML = `<div class="muted">—</div>`;
        return;
      }

      // sentiment line points
      const points = months.map(ym=>{
        const s = (m.summary && m.summary[ym]) ? m.summary[ym].sent_avg : 0;
        return { ym, v: (typeof s==="number") ? s : 0 };
      });
      elChartYearLine.innerHTML = svgLineChart(points, months);

      // heatmap: topic counts by month
      const topicKeys = (m.topic_keys || []);
      const topicLabels = (m.topic_labels_de || {});
      const matrix = {};
      topicKeys.forEach(k=>{ matrix[k]={}; months.forEach(mm=>matrix[k][mm]=0); });

      months.forEach(ym=>{
        const sum = (m.summary && m.summary[ym]) ? m.summary[ym] : null;
        if(sum && sum.topic_counts){
          for(const k of topicKeys){
            matrix[k][ym] = sum.topic_counts[k] || 0;
          }
        }
      });

      elChartHeatmap.innerHTML = svgHeatmap(months, topicKeys, matrix, topicLabels);
    }

    loadManifest().catch(err=>{
      console.error(err);
      // minimal error output
      document.getElementById("chartTopics").innerHTML = `<div class="muted">manifest.json fehlt oder kann nicht geladen werden.</div>`;
    });
  </script>
</body>
</html>
