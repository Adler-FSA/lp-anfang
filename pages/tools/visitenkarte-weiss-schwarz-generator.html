<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visitenkarte – Weiß/Schwarz Generator</title>
  <meta name="description" content="Visitenkarte Generator: Eingabefelder, QR-Werkstatt, Vorschau, Druckvorlage (weiß/schwarz), DE/EN, LocalStorage." />
  <meta name="robots" content="noindex,nofollow" />

  <style>
    :root{
      --bg:#ffffff;
      --ink:#000000;
      --muted:#333333;
      --line:#000000;
      --panel:#ffffff;

      --card-w:85mm;
      --card-h:55mm;
      --card-pad:4.5mm;
      --radius:2mm;
    }

    html,body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    .wrap{ max-width:1100px; margin:0 auto; padding:18px 16px 34px; }

    header{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap; margin-bottom:14px;
    }

    .title{ line-height:1.15; }
    .title h1{ margin:0; font-size:20px; font-weight:800; letter-spacing:.2px; }
    .title p{ margin:6px 0 0; color:var(--muted); font-size:13px; max-width:62ch; }

    .lang{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn{
      appearance:none; border:1px solid var(--line); background:#fff; color:#000;
      padding:8px 10px; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer;
    }
    .btn:active{ transform:translateY(1px); }
    .btn.small{ padding:7px 9px; font-size:12px; }
    .btn.primary{ background:#000; color:#fff; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      align-items:start;
    }

    .panel{
      border:1px solid var(--line);
      border-radius:12px;
      padding:14px;
      background:var(--panel);
    }
    .panel h2{ margin:0 0 10px; font-size:15px; font-weight:800; }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field.full{ grid-column:1 / -1; }

    label{ font-size:12px; font-weight:800; letter-spacing:.2px; }
    input{
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
      background:#fff;
      color:#000;
    }
    input::placeholder{ color:#777; }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .hint{ font-size:12px; color:var(--muted); line-height:1.35; }

    .previewWrap{ display:flex; flex-direction:column; gap:12px; align-items:flex-start; }
    .cardSheet{
      background:#fff;
      padding:12px;
      border:1px dashed #000;
      border-radius:12px;
    }

    .card{
      width:var(--card-w);
      height:var(--card-h);
      border:1px solid #000;
      border-radius:var(--radius);
      padding:var(--card-pad);
      box-sizing:border-box;
      background:#fff;
      color:#000;
      position:relative;
      overflow:hidden;
    }

    .clubMark{
      position:absolute;
      top:var(--card-pad);
      right:var(--card-pad);
      font-weight:900;
      font-size:9.5pt;
      letter-spacing:.2px;
      color:#000;
      line-height:1;
      white-space:nowrap;
    }

    .cName{
      font-weight:900;
      font-size:12.5pt;
      line-height:1.1;
      letter-spacing:.2px;
      margin:0;
      word-break:break-word;
      padding-right:22mm;
    }
    .cRole{
      margin:2mm 0 0;
      font-weight:700;
      font-size:9.5pt;
      color:#000;
      word-break:break-word;
      padding-right:22mm;
    }

    .cLine{
      height:0;
      border-top:1px solid #000;
      margin:3.2mm 0 3.2mm;
      opacity:1;
    }

    .cInfo{
      display:grid;
      grid-template-columns: 1fr;
      gap:1.2mm;
      font-size:9.2pt;
      line-height:1.15;
      color:#000;
      word-break:break-word;
      padding-right:22mm;
    }

    .mono{ font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1; }
    .empty{ opacity:.35; font-style:italic; }
    .footerNote{ font-size:12px; color:var(--muted); }

    /* QR auf Karte */
    .qrBox{
      position:absolute;
      right:var(--card-pad);
      bottom:var(--card-pad);
      width:18mm;
      height:18mm;
      border:1px solid #000;
      box-sizing:border-box;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#fff;
      padding:1.2mm;
      overflow:hidden;
    }
    .qrBox.isEmpty{ opacity:.12; }
    .qrBox img{ width:100%; height:100%; display:block; image-rendering:pixelated; }

    /* QR Werkstatt */
    .qrWorkshopBox{
      border:1px solid #000;
      border-radius:12px;
      padding:12px;
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      background:#fff;
    }
    .qrLarge{
      width:46mm;
      height:46mm;
      border:1px solid #000;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#fff;
      box-sizing:border-box;
      padding:2mm;
      overflow:hidden;
    }
    .qrLarge img{ width:100%; height:100%; display:block; image-rendering:pixelated; }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .cardSheet{ width:100%; }
    }

    @media print{
      @page{ size: A4; margin: 12mm; }
      body{ background:#fff; }
      header, .panel.formPanel, .panel.qrPanel, .footerNote, .lang, .hint, .actions{ display:none !important; }
      .wrap{ padding:0; max-width:none; }
      .grid{ display:block; }
      .panel{ border:none; padding:0; }
      .cardSheet{ border:none; padding:0; border-radius:0; }
      .card{ margin:0 auto; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1 data-i18n="h1">Visitenkarte – Weiß/Schwarz</h1>
        <p data-i18n="sub">Eingaben → Vorschau → (optional QR importieren) → Drucken / als PDF speichern.</p>
      </div>

      <div class="lang">
        <button class="btn small" id="btnDE" type="button">DE</button>
        <button class="btn small" id="btnEN" type="button">EN</button>
        <button class="btn primary" id="btnPrint" type="button" data-i18n="printBtn">Drucken / als PDF speichern</button>
      </div>
    </header>

    <div class="grid">
      <section class="panel formPanel">
        <h2 data-i18n="formTitle">Eingabefelder</h2>

        <div class="form">
          <div class="field">
            <label for="firstName" data-i18n="firstNameLabel">Vorname</label>
            <input id="firstName" type="text" placeholder="Max" autocomplete="given-name" />
          </div>
          <div class="field">
            <label for="lastName" data-i18n="lastNameLabel">Nachname</label>
            <input id="lastName" type="text" placeholder="Mustermann" autocomplete="family-name" />
          </div>
          <div class="field full">
            <label for="street" data-i18n="streetLabel">Straße & Hausnummer</label>
            <input id="street" type="text" placeholder="Musterstraße 12" autocomplete="street-address" />
          </div>
          <div class="field">
            <label for="zip" data-i18n="zipLabel">PLZ</label>
            <input id="zip" type="text" inputmode="numeric" placeholder="12345" autocomplete="postal-code" />
          </div>
          <div class="field">
            <label for="city" data-i18n="cityLabel">Ort</label>
            <input id="city" type="text" placeholder="Musterstadt" autocomplete="address-level2" />
          </div>
          <div class="field">
            <label for="mobile" data-i18n="mobileLabel">Mobil</label>
            <input id="mobile" type="tel" placeholder="+49 170 1234567" autocomplete="tel" />
          </div>
          <div class="field">
            <label for="email" data-i18n="emailLabel">E-Mail</label>
            <input id="email" type="email" placeholder="name@domain.de" autocomplete="email" />
          </div>
          <div class="field full">
            <label for="status" data-i18n="statusLabel">Status</label>
            <input id="status" type="text" data-i18n-ph="statusPH" placeholder="Mitglied, Mentor, Promotor, Sprecher, Dozent" autocomplete="off" />
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnClear" type="button" data-i18n="clearBtn">Felder leeren</button>
          <button class="btn" id="btnCopy" type="button" data-i18n="copyBtn">Text kopieren</button>
          <div class="hint" data-i18n="hint">Tipp: Nach dem Klick auf „Drucken / als PDF speichern“ im Druckdialog „Als PDF sichern“ wählen.</div>
        </div>
      </section>

      <section class="panel">
        <h2 data-i18n="previewTitle">Vorschau</h2>

        <div class="previewWrap">
          <div class="cardSheet">
            <div class="card" id="card">
              <div class="clubMark">FSA-Club</div>

              <p class="cName" id="pName">—</p>
              <p class="cRole" id="pAddr1">—</p>

              <div class="cLine"></div>

              <div class="cInfo">
                <div class="mono" id="pAddr2">—</div>
                <div class="mono" id="pMobile">—</div>
                <div class="mono" id="pEmail">—</div>
                <div class="mono" id="pStatus">—</div>
              </div>

              <div class="qrBox isEmpty" id="qrBox" aria-label="QR Code">
                <div id="qrOnCard"></div>
              </div>
            </div>
          </div>

          <div class="footerNote" data-i18n="privacy">Hinweis: Speicherung erfolgt lokal im Browser (LocalStorage). Keine Übertragung.</div>
        </div>
      </section>

      <section class="panel qrPanel" style="grid-column: 1 / -1;">
        <h2 data-i18n="qrTitle">QR-Werkstatt (Webadresse → QR → Import)</h2>

        <div class="form">
          <div class="field full">
            <label for="qrWebsite" data-i18n="qrWebLabel">Webadresse (für QR)</label>
            <input id="qrWebsite" type="text" placeholder="https://deine-domain.de/michael-rau" autocomplete="url" />
          </div>
        </div>

        <div class="qrWorkshopBox" style="margin-top:10px;">
          <div class="qrLarge">
            <div id="qrPreview"></div>
          </div>

          <div style="flex:1; min-width:240px;">
            <div class="hint" data-i18n="qrHint">
              Hier wird der QR separat erzeugt. Erst mit „In Visitenkarte übernehmen“ wird er auf die Karte gesetzt.
              Lange Webadressen müssen dann nicht mehr als Text gedruckt werden.
            </div>

            <div class="actions" style="margin-top:10px;">
              <button class="btn" id="btnMakeQr" type="button" data-i18n="qrMakeBtn">QR erzeugen</button>
              <button class="btn primary" id="btnImportQr" type="button" data-i18n="qrImportBtn">In Visitenkarte übernehmen</button>
              <button class="btn" id="btnClearQr" type="button" data-i18n="qrClearBtn">QR löschen</button>
            </div>

            <div class="hint" id="qrStatusLine" style="margin-top:6px;"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      const LS_KEY = "fsa_vcard_white_black_v7";
      const LS_LANG = "fsa_lang_vcard";
      const LS_QR_IMPORTED = "fsa_vcard_qr_imported_png";
      const LS_QR_WEBSITE = "fsa_vcard_qr_website";

      const els = {
        firstName: document.getElementById("firstName"),
        lastName: document.getElementById("lastName"),
        street: document.getElementById("street"),
        zip: document.getElementById("zip"),
        city: document.getElementById("city"),
        mobile: document.getElementById("mobile"),
        email: document.getElementById("email"),
        status: document.getElementById("status"),

        pName: document.getElementById("pName"),
        pAddr1: document.getElementById("pAddr1"),
        pAddr2: document.getElementById("pAddr2"),
        pMobile: document.getElementById("pMobile"),
        pEmail: document.getElementById("pEmail"),
        pStatus: document.getElementById("pStatus"),

        qrBox: document.getElementById("qrBox"),
        qrOnCard: document.getElementById("qrOnCard"),

        qrWebsite: document.getElementById("qrWebsite"),
        qrPreview: document.getElementById("qrPreview"),
        btnMakeQr: document.getElementById("btnMakeQr"),
        btnImportQr: document.getElementById("btnImportQr"),
        btnClearQr: document.getElementById("btnClearQr"),
        qrStatusLine: document.getElementById("qrStatusLine"),

        btnPrint: document.getElementById("btnPrint"),
        btnClear: document.getElementById("btnClear"),
        btnCopy: document.getElementById("btnCopy"),
        btnDE: document.getElementById("btnDE"),
        btnEN: document.getElementById("btnEN"),
      };

      const i18n = {
        de: {
          h1:"Visitenkarte – Weiß/Schwarz",
          sub:"Eingaben → Vorschau → (optional QR importieren) → Drucken / als PDF speichern.",
          formTitle:"Eingabefelder",
          firstNameLabel:"Vorname",
          lastNameLabel:"Nachname",
          streetLabel:"Straße & Hausnummer",
          zipLabel:"PLZ",
          cityLabel:"Ort",
          mobileLabel:"Mobil",
          emailLabel:"E-Mail",
          statusLabel:"Status",
          statusPH:"Mitglied, Mentor, Promotor, Sprecher, Dozent",
          previewTitle:"Vorschau",
          printBtn:"Drucken / als PDF speichern",
          clearBtn:"Felder leeren",
          copyBtn:"Text kopieren",
          hint:"Tipp: Nach dem Klick auf „Drucken / als PDF speichern“ im Druckdialog „Als PDF sichern“ wählen.",
          privacy:"Hinweis: Speicherung erfolgt lokal im Browser (LocalStorage). Keine Übertragung.",
          copied:"Kopiert.",
          copyFail:"Kopieren nicht möglich.",
          confirmClear:"Wirklich alle Felder leeren?",
          qrTitle:"QR-Werkstatt (Webadresse → QR → Import)",
          qrWebLabel:"Webadresse (für QR)",
          qrHint:"Hier wird der QR separat erzeugt. Erst mit „In Visitenkarte übernehmen“ wird er auf die Karte gesetzt. Lange Webadressen müssen dann nicht mehr als Text gedruckt werden.",
          qrMakeBtn:"QR erzeugen",
          qrImportBtn:"In Visitenkarte übernehmen",
          qrClearBtn:"QR löschen",
          qrNoUrl:"Bitte Webadresse eintragen.",
          qrReady:"QR bereit. Jetzt „In Visitenkarte übernehmen“.",
          qrImported:"QR wurde in die Visitenkarte übernommen.",
          qrConfirm:"QR in die Visitenkarte übernehmen?",
          qrErr:"QR Fehler (URL zu lang oder ungültig)."
        },
        en: {
          h1:"Business Card – White/Black",
          sub:"Inputs → Preview → (optional import QR) → Print / save as PDF.",
          formTitle:"Input fields",
          firstNameLabel:"First name",
          lastNameLabel:"Last name",
          streetLabel:"Street & number",
          zipLabel:"ZIP",
          cityLabel:"City",
          mobileLabel:"Mobile",
          emailLabel:"Email",
          statusLabel:"Status",
          statusPH:"Member, Mentor, Promoter, Speaker, Lecturer",
          previewTitle:"Preview",
          printBtn:"Print / save as PDF",
          clearBtn:"Clear fields",
          copyBtn:"Copy text",
          hint:"Tip: After clicking “Print / save as PDF”, choose “Save as PDF” in the print dialog.",
          privacy:"Note: Saved locally in your browser (LocalStorage). No transmission.",
          copied:"Copied.",
          copyFail:"Copy not available.",
          confirmClear:"Really clear all fields?",
          qrTitle:"QR Workshop (website → QR → import)",
          qrWebLabel:"Website (for QR)",
          qrHint:"The QR is generated separately. Only with “Import to business card” it will be placed on the card. Long URLs do not need to be printed as text.",
          qrMakeBtn:"Generate QR",
          qrImportBtn:"Import to business card",
          qrClearBtn:"Clear QR",
          qrNoUrl:"Please enter a website.",
          qrReady:"QR ready. Now click “Import to business card”.",
          qrImported:"QR imported into the business card.",
          qrConfirm:"Import QR into the business card?",
          qrErr:"QR error (URL too long or invalid)."
        }
      };

      function safe(v){ return (v||"").toString().trim(); }
      function normalizeWebsite(url){
        let v = safe(url);
        if(!v) return "";
        v = v.replace(/\s+/g,""); // harte Reinigung (iOS copy/paste)
        if(/^https?:\/\//i.test(v)) return v;
        return "https://" + v;
      }
      function setText(node, value, placeholder){
        const v = safe(value);
        if(v){ node.textContent = v; node.classList.remove("empty"); }
        else { node.textContent = placeholder; node.classList.add("empty"); }
      }

      function getLang(){
        const v = (localStorage.getItem(LS_LANG) || "de").toLowerCase();
        return (v === "en") ? "en" : "de";
      }
      function setLang(lang){
        localStorage.setItem(LS_LANG, (lang==="en")?"en":"de");
        applyI18n();
      }
      function applyI18n(){
        const lang = getLang();
        const dict = i18n[lang];
        document.documentElement.lang = lang;

        document.querySelectorAll("[data-i18n]").forEach(n=>{
          const key = n.getAttribute("data-i18n");
          if(dict[key]) n.textContent = dict[key];
        });
        document.querySelectorAll("[data-i18n-ph]").forEach(n=>{
          const key = n.getAttribute("data-i18n-ph");
          if(dict[key]) n.setAttribute("placeholder", dict[key]);
        });

        els.btnDE.style.opacity = (lang === "de") ? "1" : ".55";
        els.btnEN.style.opacity = (lang === "en") ? "1" : ".55";
      }

      function load(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if(raw){
            const data = JSON.parse(raw);
            if(data && typeof data === "object"){
              els.firstName.value = data.firstName || "";
              els.lastName.value  = data.lastName  || "";
              els.street.value    = data.street    || "";
              els.zip.value       = data.zip       || "";
              els.city.value      = data.city      || "";
              els.mobile.value    = data.mobile    || "";
              els.email.value     = data.email     || "";
              els.status.value    = data.status    || "";
            }
          }
        }catch(e){}

        els.qrWebsite.value = localStorage.getItem(LS_QR_WEBSITE) || "";

        const importedPng = localStorage.getItem(LS_QR_IMPORTED) || "";
        if(importedPng){
          els.qrOnCard.innerHTML = `<img alt="QR" src="${importedPng}">`;
          els.qrBox.classList.remove("isEmpty");
        }else{
          els.qrOnCard.innerHTML = "";
          els.qrBox.classList.add("isEmpty");
        }
      }

      function save(){
        const data = {
          firstName: safe(els.firstName.value),
          lastName:  safe(els.lastName.value),
          street:    safe(els.street.value),
          zip:       safe(els.zip.value),
          city:      safe(els.city.value),
          mobile:    safe(els.mobile.value),
          email:     safe(els.email.value),
          status:    safe(els.status.value),
        };
        try{ localStorage.setItem(LS_KEY, JSON.stringify(data)); }catch(e){}
      }

      function renderCard(){
        const first = safe(els.firstName.value);
        const last  = safe(els.lastName.value);
        const fullName = (first + " " + last).trim();

        const street = safe(els.street.value);
        const zip = safe(els.zip.value);
        const city = safe(els.city.value);
        const addr2 = ((zip ? zip : "") + (zip && city ? " " : "") + (city ? city : "")).trim();

        const mobile = safe(els.mobile.value);
        const email  = safe(els.email.value);
        const status = safe(els.status.value);

        setText(els.pName, fullName, "—");
        setText(els.pAddr1, street, "—");
        setText(els.pAddr2, addr2, "—");
        setText(els.pMobile, mobile ? ("Mobil: " + mobile) : "", "—");
        setText(els.pEmail,  email  ? ("E-Mail: " + email)  : "", "—");
        setText(els.pStatus, status ? ("Status: " + status) : "", "—");

        save();
      }

      function setQrStatus(msg){ els.qrStatusLine.textContent = msg || ""; }

      function makeQrPngDataUrl(url, targetPx){
        const qr = qrcode(0, 'Q');
        qr.addData(url);
        qr.make();

        const count = qr.getModuleCount();
        const quiet = 4;
        const dim = count + quiet * 2;

        const scale = Math.max(1, Math.floor(targetPx / dim));
        const size = dim * scale;

        const canvas = document.createElement("canvas");
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext("2d", { alpha:false });

        ctx.fillStyle = "#fff";
        ctx.fillRect(0,0,size,size);

        ctx.fillStyle = "#000";
        for(let r=0; r<count; r++){
          for(let c=0; c<count; c++){
            if(qr.isDark(r,c)){
              const x = (c + quiet) * scale;
              const y = (r + quiet) * scale;
              ctx.fillRect(x,y,scale,scale);
            }
          }
        }

        return canvas.toDataURL("image/png");
      }

      function makeQrPreview(){
        const t = i18n[getLang()];
        const raw = safe(els.qrWebsite.value);
        if(!raw){
          els.qrPreview.innerHTML = "";
          setQrStatus(t.qrNoUrl);
          return "";
        }
        const url = normalizeWebsite(raw);

        try{
          const png = makeQrPngDataUrl(url, 900);
          els.qrPreview.innerHTML = `<img alt="QR" src="${png}">`;
          localStorage.setItem(LS_QR_WEBSITE, raw);
          setQrStatus(t.qrReady);
          return png;
        }catch(e){
          els.qrPreview.innerHTML = "";
          // echter Fehlertext (damit sofort klar ist, WAS crasht)
          setQrStatus(t.qrErr + (e && e.message ? (" (" + e.message + ")") : ""));
          return "";
        }
      }

      function importQrToCard(){
        const t = i18n[getLang()];
        if(!confirm(t.qrConfirm)) return;

        const raw = safe(els.qrWebsite.value);
        if(!raw) return;

        const url = normalizeWebsite(raw);

        try{
          const png = makeQrPngDataUrl(url, 420);
          els.qrOnCard.innerHTML = `<img alt="QR" src="${png}">`;
          els.qrBox.classList.remove("isEmpty");
          localStorage.setItem(LS_QR_IMPORTED, png);
          // auch hier Status sauber
          setQrStatus(t.qrImported);
        }catch(e){
          setQrStatus(t.qrErr + (e && e.message ? (" (" + e.message + ")") : ""));
        }
      }

      function clearQr(){
        els.qrPreview.innerHTML = "";
        els.qrOnCard.innerHTML = "";
        els.qrBox.classList.add("isEmpty");
        localStorage.removeItem(LS_QR_IMPORTED);
      }

      function wire(){
        ["firstName","lastName","street","zip","city","mobile","email","status"].forEach(id=>{
          els[id].addEventListener("input", renderCard);
          els[id].addEventListener("change", renderCard);
        });

        els.btnPrint.addEventListener("click", ()=>{ renderCard(); window.print(); });

        els.btnClear.addEventListener("click", ()=>{
          const t = i18n[getLang()];
          if(!confirm(t.confirmClear)) return;
          els.firstName.value = "";
          els.lastName.value  = "";
          els.street.value    = "";
          els.zip.value       = "";
          els.city.value      = "";
          els.mobile.value    = "";
          els.email.value     = "";
          els.status.value    = "";
          save();
          renderCard();
        });

        els.btnCopy.addEventListener("click", async ()=>{
          const t = i18n[getLang()];
          const first = safe(els.firstName.value);
          const last  = safe(els.lastName.value);
          const fullName = (first + " " + last).trim();
          const street = safe(els.street.value);
          const zip = safe(els.zip.value);
          const city = safe(els.city.value);
          const addr2 = ((zip ? zip : "") + (zip && city ? " " : "") + (city ? city : "")).trim();
          const mobile = safe(els.mobile.value);
          const email  = safe(els.email.value);
          const status = safe(els.status.value);

          const lines = [
            fullName || "",
            street || "",
            addr2 || "",
            mobile ? ("Mobil: " + mobile) : "",
            email ? ("E-Mail: " + email) : "",
            status ? ("Status: " + status) : ""
          ].filter(Boolean);

          const text = lines.join("\n");
          try{
            if(navigator.clipboard && navigator.clipboard.writeText){
              await navigator.clipboard.writeText(text);
              els.btnCopy.textContent = t.copied;
              setTimeout(()=>{ els.btnCopy.textContent = t.copyBtn; }, 900);
            }else{
              throw new Error("no clipboard");
            }
          }catch(e){
            alert(t.copyFail);
          }
        });

        els.btnDE.addEventListener("click", ()=>{ setLang("de"); setQrStatus(""); });
        els.btnEN.addEventListener("click", ()=>{ setLang("en"); setQrStatus(""); });

        els.btnMakeQr.addEventListener("click", ()=>{ makeQrPreview(); });
        els.btnImportQr.addEventListener("click", ()=>{
          if(!els.qrPreview.querySelector("img")) makeQrPreview();
          importQrToCard();
        });
        els.btnClearQr.addEventListener("click", ()=>{
          clearQr();
          setQrStatus("");
        });
      }

      load();
      applyI18n();
      wire();
      renderCard();
      if(safe(els.qrWebsite.value)) makeQrPreview();
    })();
  </script>

  <script>
    /*
      qrcode-generator (classic) – offline
      (MIT) kazuhikoarase/qrcode-generator
      => stabile Original-Logik: RS_TABLE Index = (type-1)*4 + level
    */
    (function(global){
      function qrcode(typeNumber, errorCorrectionLevel) {

        var PAD0 = 0xEC;
        var PAD1 = 0x11;

        var _typeNumber = typeNumber;
        var _errorCorrectionLevel = QRErrorCorrectionLevel[errorCorrectionLevel];
        var _modules = null;
        var _moduleCount = 0;
        var _dataCache = null;
        var _dataList = [];

        var makeImpl = function(test, maskPattern) {

          _moduleCount = _typeNumber * 4 + 17;
          _modules = new Array(_moduleCount);

          for (var row = 0; row < _moduleCount; row++) {

            _modules[row] = new Array(_moduleCount);

            for (var col = 0; col < _moduleCount; col++) {
              _modules[row][col] = null;
            }
          }

          setupPositionProbePattern(0, 0);
          setupPositionProbePattern(_moduleCount - 7, 0);
          setupPositionProbePattern(0, _moduleCount - 7);
          setupPositionAdjustPattern();
          setupTimingPattern();
          setupTypeInfo(test, maskPattern);

          if (_typeNumber >= 7) {
            setupTypeNumber(test);
          }

          if (_dataCache == null) {
            _dataCache = createData(_typeNumber, _errorCorrectionLevel, _dataList);
          }

          mapData(_dataCache, maskPattern);
        };

        var setupPositionProbePattern = function(row, col) {

          for (var r = -1; r <= 7; r++) {

            if (row + r <= -1 || _moduleCount <= row + r) continue;

            for (var c = -1; c <= 7; c++) {

              if (col + c <= -1 || _moduleCount <= col + c) continue;

              if ((0 <= r && r <= 6 && (c == 0 || c == 6))
                  || (0 <= c && c <= 6 && (r == 0 || r == 6))
                  || (2 <= r && r <= 4 && 2 <= c && c <= 4)) {
                _modules[row + r][col + c] = true;
              } else {
                _modules[row + r][col + c] = false;
              }
            }
          }
        };

        var getBestMaskPattern = function() {

          var minLostPoint = 0;
          var pattern = 0;

          for (var i = 0; i < 8; i++) {

            makeImpl(true, i);

            var lostPoint = QRUtil.getLostPoint(this);

            if (i == 0 || minLostPoint > lostPoint) {
              minLostPoint = lostPoint;
              pattern = i;
            }
          }

          return pattern;
        };

        var setupTimingPattern = function() {

          for (var r = 8; r < _moduleCount - 8; r++) {
            if (_modules[r][6] != null) continue;
            _modules[r][6] = (r % 2 == 0);
          }

          for (var c = 8; c < _moduleCount - 8; c++) {
            if (_modules[6][c] != null) continue;
            _modules[6][c] = (c % 2 == 0);
          }
        };

        var setupPositionAdjustPattern = function() {

          var pos = QRUtil.getPatternPosition(_typeNumber);

          for (var i = 0; i < pos.length; i++) {

            for (var j = 0; j < pos.length; j++) {

              var row = pos[i];
              var col = pos[j];

              if (_modules[row][col] != null) continue;

              for (var r = -2; r <= 2; r++) {

                for (var c = -2; c <= 2; c++) {

                  if (r == -2 || r == 2 || c == -2 || c == 2
                      || (r == 0 && c == 0)) {
                    _modules[row + r][col + c] = true;
                  } else {
                    _modules[row + r][col + c] = false;
                  }
                }
              }
            }
          }
        };

        var setupTypeNumber = function(test) {

          var bits = QRUtil.getBCHTypeNumber(_typeNumber);

          for (var i = 0; i < 18; i++) {
            var mod = (!test && ((bits >> i) & 1) == 1);
            _modules[Math.floor(i / 3)][i % 3 + _moduleCount - 8 - 3] = mod;
          }

          for (var i = 0; i < 18; i++) {
            var mod = (!test && ((bits >> i) & 1) == 1);
            _modules[i % 3 + _moduleCount - 8 - 3][Math.floor(i / 3)] = mod;
          }
        };

        var setupTypeInfo = function(test, maskPattern) {

          var data = (_errorCorrectionLevel << 3) | maskPattern;
          var bits = QRUtil.getBCHTypeInfo(data);

          for (var i = 0; i < 15; i++) {

            var mod = (!test && ((bits >> i) & 1) == 1);

            if (i < 6) {
              _modules[i][8] = mod;
            } else if (i < 8) {
              _modules[i + 1][8] = mod;
            } else {
              _modules[_moduleCount - 15 + i][8] = mod;
            }
          }

          for (var i = 0; i < 15; i++) {

            var mod = (!test && ((bits >> i) & 1) == 1);

            if (i < 8) {
              _modules[8][_moduleCount - i - 1] = mod;
            } else if (i < 9) {
              _modules[8][15 - i - 1 + 1] = mod;
            } else {
              _modules[8][15 - i - 1] = mod;
            }
          }

          _modules[_moduleCount - 8][8] = (!test);
        };

        var mapData = function(data, maskPattern) {

          var inc = -1;
          var row = _moduleCount - 1;
          var bitIndex = 7;
          var byteIndex = 0;

          for (var col = _moduleCount - 1; col > 0; col -= 2) {

            if (col == 6) col--;

            while (true) {

              for (var c = 0; c < 2; c++) {

                if (_modules[row][col - c] == null) {

                  var dark = false;

                  if (byteIndex < data.length) {
                    dark = (((data[byteIndex] >>> bitIndex) & 1) == 1);
                  }

                  var mask = QRUtil.getMask(maskPattern, row, col - c);

                  if (mask) {
                    dark = !dark;
                  }

                  _modules[row][col - c] = dark;
                  bitIndex--;

                  if (bitIndex == -1) {
                    byteIndex++;
                    bitIndex = 7;
                  }
                }
              }

              row += inc;

              if (row < 0 || _moduleCount <= row) {
                row -= inc;
                inc = -inc;
                break;
              }
            }
          }
        };

        var createData = function(typeNumber, errorCorrectionLevel, dataList) {

          var rsBlocks = QRRSBlock.getRSBlocks(typeNumber, errorCorrectionLevel);
          var buffer = new QRBitBuffer();

          for (var i = 0; i < dataList.length; i++) {
            var data = dataList[i];
            buffer.put(data.getMode(), 4);
            buffer.put(data.getLength(), QRUtil.getLengthInBits(data.getMode(), typeNumber));
            data.write(buffer);
          }

          var totalDataCount = 0;
          for (var i = 0; i < rsBlocks.length; i++) {
            totalDataCount += rsBlocks[i].dataCount;
          }

          if (buffer.getLengthInBits() > totalDataCount * 8) {
            throw new Error("code length overflow");
          }

          if (buffer.getLengthInBits() + 4 <= totalDataCount * 8) {
            buffer.put(0, 4);
          }

          while (buffer.getLengthInBits() % 8 != 0) {
            buffer.putBit(false);
          }

          while (true) {

            if (buffer.getLengthInBits() >= totalDataCount * 8) {
              break;
            }
            buffer.put(PAD0, 8);

            if (buffer.getLengthInBits() >= totalDataCount * 8) {
              break;
            }
            buffer.put(PAD1, 8);
          }

          return createBytes(buffer, rsBlocks);
        };

        var createBytes = function(buffer, rsBlocks) {

          var offset = 0;

          var maxDcCount = 0;
          var maxEcCount = 0;

          var dcdata = new Array(rsBlocks.length);
          var ecdata = new Array(rsBlocks.length);

          for (var r = 0; r < rsBlocks.length; r++) {

            var dcCount = rsBlocks[r].dataCount;
            var ecCount = rsBlocks[r].totalCount - dcCount;

            maxDcCount = Math.max(maxDcCount, dcCount);
            maxEcCount = Math.max(maxEcCount, ecCount);

            dcdata[r] = new Array(dcCount);

            for (var i = 0; i < dcdata[r].length; i++) {
              dcdata[r][i] = 0xff & buffer.getBuffer()[i + offset];
            }
            offset += dcCount;

            var rsPoly = QRUtil.getErrorCorrectPolynomial(ecCount);
            var rawPoly = qrPolynomial(dcdata[r], rsPoly.getLength() - 1);

            var modPoly = rawPoly.mod(rsPoly);
            ecdata[r] = new Array(rsPoly.getLength() - 1);

            for (var i = 0; i < ecdata[r].length; i++) {
              var modIndex = i + modPoly.getLength() - ecdata[r].length;
              ecdata[r][i] = (modIndex >= 0) ? modPoly.get(modIndex) : 0;
            }
          }

          var totalCodeCount = 0;
          for (var i = 0; i < rsBlocks.length; i++) {
            totalCodeCount += rsBlocks[i].totalCount;
          }

          var data = new Array(totalCodeCount);
          var index = 0;

          for (var i = 0; i < maxDcCount; i++) {
            for (var r = 0; r < rsBlocks.length; r++) {
              if (i < dcdata[r].length) {
                data[index++] = dcdata[r][i];
              }
            }
          }

          for (var i = 0; i < maxEcCount; i++) {
            for (var r = 0; r < rsBlocks.length; r++) {
              if (i < ecdata[r].length) {
                data[index++] = ecdata[r][i];
              }
            }
          }

          return data;
        };

        this.addData = function(data) {
          _dataCache = null;
          _dataList.push(new QR8BitByte(data));
        };

        this.isDark = function(row, col) {
          if (_modules[row][col] != null) return _modules[row][col];
          return false;
        };

        this.getModuleCount = function() {
          return _moduleCount;
        };

        this.make = function() {

          if (_typeNumber < 1) {
            _typeNumber = 1;
            for (; _typeNumber < 40; _typeNumber++) {
              var rsBlocks = QRRSBlock.getRSBlocks(_typeNumber, _errorCorrectionLevel);
              var buffer = new QRBitBuffer();
              for (var i = 0; i < _dataList.length; i++) {
                var data = _dataList[i];
                buffer.put(data.getMode(), 4);
                buffer.put(data.getLength(), QRUtil.getLengthInBits(data.getMode(), _typeNumber));
                data.write(buffer);
              }
              var totalDataCount = 0;
              for (var i = 0; i < rsBlocks.length; i++) totalDataCount += rsBlocks[i].dataCount;
              if (buffer.getLengthInBits() <= totalDataCount * 8) break;
            }
          }
          makeImpl(false, getBestMaskPattern());
        };
      }

      var QRMode = { MODE_8BIT_BYTE: 1 << 2 };

      var QRErrorCorrectionLevel = { L:1, M:0, Q:3, H:2 };

      function QR8BitByte(data) {
        this.mode = QRMode.MODE_8BIT_BYTE;
        this.data = data;
        this.getMode = function() { return this.mode; };
        this.getLength = function() { return QRUtil.getUTF8Length(this.data); };
        this.write = function(buffer) { QRUtil.writeUTF8(buffer, this.data); };
      }

      function QRBitBuffer() {
        this.buffer = [];
        this.length = 0;
        this.getBuffer = function() { return this.buffer; };
        this.getLengthInBits = function() { return this.length; };
        this.put = function(num, length) {
          for (var i = 0; i < length; i++) {
            this.putBit(((num >>> (length - i - 1)) & 1) == 1);
          }
        };
        this.putBit = function(bit) {
          var bufIndex = Math.floor(this.length / 8);
          if (this.buffer.length <= bufIndex) this.buffer.push(0);
          if (bit) this.buffer[bufIndex] |= (0x80 >>> (this.length % 8));
          this.length++;
        };
      }

      function qrPolynomial(num, shift) {
        var offset = 0;
        while (offset < num.length && num[offset] == 0) offset++;
        var _num = new Array(num.length - offset + shift);
        for (var i = 0; i < num.length - offset; i++) _num[i] = num[i + offset];

        this.get = function(index) { return _num[index]; };
        this.getLength = function() { return _num.length; };

        this.multiply = function(e) {
          var num = new Array(this.getLength() + e.getLength() - 1);
          for (var i = 0; i < num.length; i++) num[i] = 0;
          for (var i = 0; i < this.getLength(); i++) {
            for (var j = 0; j < e.getLength(); j++) {
              num[i + j] ^= QRMath.gexp(QRMath.glog(this.get(i)) + QRMath.glog(e.get(j)));
            }
          }
          return new qrPolynomial(num, 0);
        };

        this.mod = function(e) {
          if (this.getLength() - e.getLength() < 0) return this;
          var ratio = QRMath.glog(this.get(0)) - QRMath.glog(e.get(0));
          var num = new Array(this.getLength());
          for (var i = 0; i < this.getLength(); i++) num[i] = this.get(i);
          for (var i = 0; i < e.getLength(); i++) {
            num[i] ^= QRMath.gexp(QRMath.glog(e.get(i)) + ratio);
          }
          return new qrPolynomial(num, 0).mod(e);
        };
      }

      var QRMath = {
        glog: function(n) { if (n < 1) throw new Error("glog(" + n + ")"); return QRMath.LOG_TABLE[n]; },
        gexp: function(n) { while (n < 0) n += 255; while (n >= 256) n -= 255; return QRMath.EXP_TABLE[n]; },
        EXP_TABLE: new Array(256),
        LOG_TABLE: new Array(256)
      };

      for (var i = 0; i < 8; i++) QRMath.EXP_TABLE[i] = 1 << i;
      for (var i = 8; i < 256; i++) QRMath.EXP_TABLE[i] =
        QRMath.EXP_TABLE[i - 4] ^ QRMath.EXP_TABLE[i - 5] ^ QRMath.EXP_TABLE[i - 6] ^ QRMath.EXP_TABLE[i - 8];
      for (var i = 0; i < 255; i++) QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]] = i;

      var QRRSBlock = {
        getRSBlocks: function(typeNumber, errorCorrectionLevel) {
          var rsBlock = QRRSBlock.getRsBlockTable(typeNumber, errorCorrectionLevel);
          if (rsBlock == undefined) throw new Error("bad rs block");
          var length = rsBlock.length / 3;
          var list = [];
          for (var i = 0; i < length; i++) {
            var count = rsBlock[i * 3 + 0];
            var totalCount = rsBlock[i * 3 + 1];
            var dataCount = rsBlock[i * 3 + 2];
            for (var j = 0; j < count; j++) list.push({ totalCount: totalCount, dataCount: dataCount });
          }
          return list;
        },

        RS_BLOCK_TABLE: [
          // 1..40 (L/M/Q/H) – gleiche Tabelle wie in deinem funktionierenden Block
          [1,26,19, 1,26,16, 1,26,13, 1,26,9],
          [1,44,34, 1,44,28, 1,44,22, 1,44,16],
          [1,70,55, 1,70,44, 2,35,17, 2,35,13],
          [1,100,80, 2,50,32, 2,50,24, 4,25,9],
          [1,134,108, 2,67,43, 2,33,15,2,34,16, 2,33,11,2,34,12],
          [2,86,68, 4,43,27, 4,43,19, 4,43,15],
          [2,98,78, 4,49,31, 2,32,14,4,33,15, 4,39,13,1,40,14],
          [2,121,97, 2,60,38,2,61,39, 4,40,18,2,41,19, 4,40,14,2,41,15],
          [2,146,116, 3,58,36,2,59,37, 4,36,16,4,37,17, 4,36,12,4,37,13],
          [2,86,68,2,87,69, 4,69,43,1,70,44, 6,43,19,2,44,20, 6,43,15,2,44,16],

          [4,101,81, 1,80,50,4,81,51, 4,50,22,4,51,23, 3,36,12,8,37,13],
          [2,116,92,2,117,93, 6,58,36,2,59,37, 4,46,20,6,47,21, 7,42,14,4,43,15],
          [4,133,107, 8,59,37,1,60,38, 8,44,20,4,45,21, 12,33,11,4,34,12],
          [3,145,115,1,146,116, 4,64,40,5,65,41, 11,36,16,5,37,17, 11,36,12,5,37,13],
          [5,109,87,1,110,88, 5,65,41,5,66,42, 5,54,24,7,55,25, 11,36,12,7,37,13],
          [5,122,98,1,123,99, 7,73,45,3,74,46, 15,43,19,2,44,20, 3,45,15,13,46,16],
          [1,135,107,5,136,108, 10,74,46,1,75,47, 1,50,22,15,51,23, 2,42,14,17,43,15],
          [5,150,120,1,151,121, 9,69,43,4,70,44, 17,50,22,1,51,23, 2,42,14,19,43,15],
          [3,141,113,4,142,114, 3,70,44,11,71,45, 17,47,21,4,48,22, 9,39,13,16,40,14],
          [3,135,107,5,136,108, 3,67,41,13,68,42, 15,54,24,5,55,25, 15,43,15,10,44,16],

          [4,144,116,4,145,117, 17,68,42, 17,50,22,6,51,23, 19,46,16,6,47,17],
          [2,139,111,7,140,112, 17,74,46, 7,54,24,16,55,25, 34,37,13],
          [4,151,121,5,152,122, 4,75,47,14,76,48, 11,54,24,14,55,25, 16,45,15,14,46,16],
          [6,147,117,4,148,118, 6,73,45,14,74,46, 11,54,24,16,55,25, 30,46,16,2,47,17],
          [8,132,106,4,133,107, 8,75,47,13,76,48, 7,54,24,22,55,25, 22,45,15,13,46,16],
          [10,142,114,2,143,115, 19,74,46,4,75,47, 28,50,22,6,51,23, 33,46,16,4,47,17],
          [8,152,122,4,153,123, 22,73,45,3,74,46, 8,53,23,26,54,24, 12,45,15,28,46,16],
          [3,147,117,10,148,118, 3,73,45,23,74,46, 4,54,24,31,55,25, 11,45,15,31,46,16],
          [7,146,116,7,147,117, 21,73,45,7,74,46, 1,53,23,37,54,24, 19,45,15,26,46,16],
          [5,145,115,10,146,116, 19,75,47,10,76,48, 15,54,24,25,55,25, 23,45,15,25,46,16],

          [13,145,115,3,146,116, 2,74,46,29,75,47, 42,54,24,1,55,25, 23,45,15,28,46,16],
          [17,145,115, 10,74,46,23,75,47, 10,54,24,35,55,25, 19,45,15,35,46,16],
          [17,145,115,1,146,116, 14,74,46,21,75,47, 29,54,24,19,55,25, 11,45,15,46,46,16],
          [13,145,115,6,146,116, 14,74,46,23,75,47, 44,54,24,7,55,25, 59,46,16,1,47,17],
          [12,151,121,7,152,122, 12,75,47,26,76,48, 39,54,24,14,55,25, 22,45,15,41,46,16],
          [6,151,121,14,152,122, 6,75,47,34,76,48, 46,54,24,10,55,25, 2,45,15,64,46,16],
          [17,152,122,4,153,123, 29,74,46,14,75,47, 49,54,24,10,55,25, 24,45,15,46,46,16],
          [4,152,122,18,153,123, 13,74,46,32,75,47, 48,54,24,14,55,25, 42,45,15,32,46,16],
          [20,147,117,4,148,118, 40,75,47,7,76,48, 43,54,24,22,55,25, 10,45,15,67,46,16],
          [19,148,118,6,149,119, 18,75,47,31,76,48, 34,54,24,34,55,25, 20,45,15,61,46,16]
        ],

        getRsBlockTable: function(typeNumber, errorCorrectionLevel) {
          switch(errorCorrectionLevel) {
            case QRErrorCorrectionLevel.L:
              return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 0];
            case QRErrorCorrectionLevel.M:
              return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 1];
            case QRErrorCorrectionLevel.Q:
              return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 2];
            case QRErrorCorrectionLevel.H:
              return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 3];
            default:
              return undefined;
          }
        }
      };

      var QRUtil = {
        PATTERN_POSITION_TABLE: [
          [],
          [6, 18],[6, 22],[6, 26],[6, 30],[6, 34],[6, 22, 38],[6, 24, 42],[6, 26, 46],[6, 28, 50],
          [6, 30, 54],[6, 32, 58],[6, 34, 62],[6, 26, 46, 66],[6, 26, 48, 70],[6, 26, 50, 74],
          [6, 30, 54, 78],[6, 30, 56, 82],[6, 30, 58, 86],[6, 34, 62, 90],[6, 28, 50, 72, 94],
          [6, 26, 50, 74, 98],[6, 30, 54, 78, 102],[6, 28, 54, 80, 106],[6, 32, 58, 84, 110],
          [6, 30, 58, 86, 114],[6, 34, 62, 90, 118],[6, 26, 50, 74, 98, 122],[6, 30, 54, 78, 102, 126],
          [6, 26, 52, 78, 104, 130],[6, 30, 56, 82, 108, 134],[6, 34, 60, 86, 112, 138],[6, 30, 58, 86, 114, 142],
          [6, 34, 62, 90, 118, 146],[6, 30, 54, 78, 102, 126, 150],[6, 24, 50, 76, 102, 128, 154],
          [6, 28, 54, 80, 106, 132, 158],[6, 32, 58, 84, 110, 136, 162],[6, 26, 54, 82, 110, 138, 166],
          [6, 30, 58, 86, 114, 142, 170]
        ],
        G15: (1 << 10) | (1 << 8) | (1 << 5) | (1 << 4) | (1 << 2) | (1 << 1) | (1 << 0),
        G18: (1 << 12) | (1 << 11) | (1 << 10) | (1 << 9) | (1 << 8) | (1 << 5) | (1 << 2) | (1 << 0),
        G15_MASK: (1 << 14) | (1 << 12) | (1 << 10) | (1 << 4) | (1 << 1),

        getBCHTypeInfo: function(data) {
          var d = data << 10;
          while (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G15) >= 0) {
            d ^= (QRUtil.G15 << (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G15)));
          }
          return ((data << 10) | d) ^ QRUtil.G15_MASK;
        },

        getBCHTypeNumber: function(data) {
          var d = data << 12;
          while (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G18) >= 0) {
            d ^= (QRUtil.G18 << (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G18)));
          }
          return (data << 12) | d;
        },

        getBCHDigit: function(data) {
          var digit = 0;
          while (data != 0) { digit++; data >>>= 1; }
          return digit;
        },

        getPatternPosition: function(typeNumber) {
          return QRUtil.PATTERN_POSITION_TABLE[typeNumber - 1];
        },

        getMask: function(maskPattern, i, j) {
          switch (maskPattern) {
            case 0: return (i + j) % 2 == 0;
            case 1: return i % 2 == 0;
            case 2: return j % 3 == 0;
            case 3: return (i + j) % 3 == 0;
            case 4: return (Math.floor(i / 2) + Math.floor(j / 3)) % 2 == 0;
            case 5: return (i * j) % 2 + (i * j) % 3 == 0;
            case 6: return ((i * j) % 2 + (i * j) % 3) % 2 == 0;
            case 7: return ((i * j) % 3 + (i + j) % 2) % 2 == 0;
            default: throw new Error("bad maskPattern:" + maskPattern);
          }
        },

        getErrorCorrectPolynomial: function(errorCorrectLength) {
          var a = new qrPolynomial([1], 0);
          for (var i = 0; i < errorCorrectLength; i++) {
            a = a.multiply(new qrPolynomial([1, QRMath.gexp(i)], 0));
          }
          return a;
        },

        getLengthInBits: function(mode, type) {
          if (1 <= type && type < 10) return 8;
          if (type < 27) return 16;
          return 16;
        },

        getLostPoint: function(qrCode) {
          // (original quick scoring)
          var moduleCount = qrCode.getModuleCount();
          var lostPoint = 0;

          for (var row = 0; row < moduleCount; row++) {
            for (var col = 0; col < moduleCount; col++) {
              var sameCount = 0;
              var dark = qrCode.isDark(row, col);

              for (var r = -1; r <= 1; r++) {
                if (row + r < 0 || moduleCount <= row + r) continue;
                for (var c = -1; c <= 1; c++) {
                  if (col + c < 0 || moduleCount <= col + c) continue;
                  if (r == 0 && c == 0) continue;
                  if (dark == qrCode.isDark(row + r, col + c)) sameCount++;
                }
              }
              if (sameCount > 5) lostPoint += (3 + sameCount - 5);
            }
          }
          return lostPoint;
        },

        getUTF8Length: function(s) {
          var len = 0;
          for (var i = 0; i < s.length; i++) {
            var c = s.charCodeAt(i);
            if (c < 0x80) len++;
            else if (c < 0x800) len += 2;
            else if (0xD800 <= c && c <= 0xDBFF) { len += 4; i++; }
            else len += 3;
          }
          return len;
        },

        writeUTF8: function(buffer, s) {
          for (var i = 0; i < s.length; i++) {
            var c = s.charCodeAt(i);
            if (c < 0x80) {
              buffer.put(c, 8);
            } else if (c < 0x800) {
              buffer.put(0xC0 | (c >>> 6), 8);
              buffer.put(0x80 | (c & 0x3F), 8);
            } else if (0xD800 <= c && c <= 0xDBFF) {
              var c2 = s.charCodeAt(++i);
              var cp = 0x10000 + (((c & 0x3FF) << 10) | (c2 & 0x3FF));
              buffer.put(0xF0 | (cp >>> 18), 8);
              buffer.put(0x80 | ((cp >>> 12) & 0x3F), 8);
              buffer.put(0x80 | ((cp >>> 6) & 0x3F), 8);
              buffer.put(0x80 | (cp & 0x3F), 8);
            } else {
              buffer.put(0xE0 | (c >>> 12), 8);
              buffer.put(0x80 | ((c >>> 6) & 0x3F), 8);
              buffer.put(0x80 | (c & 0x3F), 8);
            }
          }
        }
      };

      // expose
      global.qrcode = function(typeNumber, errorCorrectionLevel){
        if (typeNumber === 0) typeNumber = -1;
        return new qrcode(typeNumber, errorCorrectionLevel);
      };
      global.QRErrorCorrectionLevel = QRErrorCorrectionLevel;

    })(window);
  </script>
</body>
</html>
